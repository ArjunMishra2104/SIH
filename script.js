document.addEventListener('DOMContentLoaded', function() {
    
    const locationData = { "Alappuzha": { villages: ["Kayamkulam", "Cherthala", "Ambalapuzha", "Chengannur"], crop: "paddy", soil: "alluvial" },"Ernakulam": { villages: ["Kochi", "Aluva", "Muvattupuzha", "Kothamangalam"], crop: "coconut", soil: "laterite" },"Idukki": { villages: ["Thodupuzha", "Kattappana", "Adimali", "Munnar"], crop: "rubber", soil: "laterite" },"Kannur": { villages: ["Thalassery", "Payyanur", "Iritty", "Mattanur"], crop: "coconut", soil: "laterite" },"Kasaragod": { villages: ["Kanhangad", "Nileshwaram", "Manjeshwar", "Vellarikundu"], crop: "coconut", soil: "laterite" },"Kollam": { villages: ["Punalur", "Karunagappally", "Kottarakkara", "Pathanapuram"], crop: "paddy", soil: "alluvial" },"Kottayam": { villages: ["Changanassery", "Pala", "Vaikom", "Kanjirappally"], crop: "rubber", soil: "laterite" },"Kozhikode": { villages: ["Vatakara", "Koyilandy", "Thamarassery", "Perambra"], crop: "coconut", soil: "laterite" },"Malappuram": { villages: ["Tirur", "Perinthalmanna", "Manjeri", "Ponnani"], crop: "coconut", soil: "laterite" },"Palakkad": { villages: ["Ottapalam", "Chittur", "Alathur", "Mannarkkad"], crop: "paddy", soil: "clayey" },"Pathanamthitta": { villages: ["Thiruvalla", "Adoor", "Ranni", "Konni"], crop: "rubber", soil: "laterite" },"Thiruvananthapuram": { villages: ["Neyyattinkara", "Attingal", "Nedumangad", "Varkala"], crop: "coconut", soil: "laterite" },"Thrissur": { villages: ["Chalakudy", "Kodungallur", "Irinjalakuda", "Guruvayur"], crop: "paddy", soil: "clayey" },"Wayanad": { villages: ["Kalpetta", "Sultan Bathery", "Mananthavady", "Vythiri"], crop: "banana", soil: "laterite" }};
    const translations = {
        en: { alertText: "Important Alert: Heavy rain expected in Chittur today. Please take necessary precautions.", gov: "Government of India", ministry: "Ministry of Agriculture & Farmers Welfare", fontSize: "Font Size:", tagline: "Your Personal AI Farming Assistant", navHome: "Home", navSchemes: "Schemes", navProfile: "Farmer Profile", navChat: "Chat Assistant", heroTitle: "Empowering Kerala's Farmers with Personalised AI Guidance", heroSubtitle: "Explore government schemes, get timely advice, and track your farm activities to increase your yield.", heroButton: "Create Your Farm Profile", schemesTitle: "Government Schemes & Yojana", schemesSubtitle: "Find schemes relevant to your needs. Click a category to filter.", schemeFilterAll: "All Schemes", schemeFilterInsurance: "Crop Insurance", schemeFilterSubsidy: "Subsidy", schemeFilterIncome: "Income Support", pmfbyTitle: "Pradhan Mantri Fasal Bima Yojana", pmfbyDesc: "Provides comprehensive insurance coverage against crop failure.", schemeEligibility: "Eligibility:", pmfbyEligibility: "All farmers growing notified crops.", schemeApply: "Learn More & Apply", pmkisanTitle: "PM-KISAN Scheme", pmkisanDesc: "Financial benefit of ₹6,000 per year for eligible farmer families.", pmkisanEligibility: "All landholding farmer families.", smamTitle: "Sub-Mission on Agricultural Mechanization", smamDesc: "Subsidies on tractors and other agricultural machinery.", smamEligibility: "Individual farmers and groups.", nhmTitle: "National Horticulture Mission (NHM)", nhmDesc: "Subsidies for growing fruits, vegetables, and horticultural crops.", nhmEligibility: "Farmers in horticulture.", profileTitle: "Create Your Farmer & Farm Profile", profileSubtitle: "Provide your details to get started with personalized advisories.", formName: "Full Name", formDistrict: "District (Click to auto-detect)", selectDistrict: "Select District", formVillage: "Village / Town", selectVillage: "Select Village", selectVillageFirst: "Select a district first", formLandSize: "Land Size (Acres)", formCrop: "Primary Crop", selectCrop: "Select Crop", cropPaddy: "Paddy (Rice)", cropCoconut: "Coconut", cropRubber: "Rubber", cropBanana: "Banana", formSoil: "Soil Type", selectSoil: "Select Soil Type", soilAlluvial: "Alluvial", soilLaterite: "Laterite", soilClayey: "Clayey", formButton: "Save Profile", chatTitle: "Your Digital Companion", chatSubtitle: "Ask questions or log your activities in Malayalam.", chatPlaceholder: "Type a message...", chatGreeting: "Hello! I am Krishi Sakhi. How can I assist you today?", footerDesc: "Krishi Sakhi is an AI-powered initiative to support farmers.", footerLinks: "Quick Links", footerAbout: "About Us", footerContact: "Contact Support", footerTerms: "Terms of Service" },
        ml: { alertText: "പ്രധാന മുന്നറിയിപ്പ്: ചിറ്റൂരിൽ ഇന്ന് കനത്ത മഴയ്ക്ക് സാധ്യത. ദയവായി മുൻകരുതലുകൾ എടുക്കുക.", gov: "ഭാരത സർക്കാർ", ministry: "കൃഷി കർഷക ക്ഷേമ മന്ത്രാലയം", fontSize: "അക്ഷരവലിപ്പം:", tagline: "നിങ്ങളുടെ സ്വകാര്യ എഐ കാർഷിക സഹായി", navHome: "ഹോം", navSchemes: "പദ്ധതികൾ", navProfile: "കർഷക പ്രൊഫൈൽ", navChat: "ചാറ്റ് അസിസ്റ്റന്റ്", heroTitle: "കേരളത്തിലെ കർഷകർക്ക് വ്യക്തിഗത എഐ മാർഗ്ഗനിർദ്ദേശം", heroSubtitle: "സർക്കാർ പദ്ധതികൾ കണ്ടെത്തുക, കൃത്യസമയത്ത് ഉപദേശം നേടുക, വിളവ് വർദ്ധിപ്പിക്കുന്നതിന് നിങ്ങളുടെ കാർഷിക പ്രവർത്തനങ്ങൾ നിരീക്ഷിക്കുക.", heroButton: "നിങ്ങളുടെ ഫാം പ്രൊഫൈൽ ഉണ്ടാക്കുക", schemesTitle: "സർക്കാർ പദ്ധതികളും യോജനകളും", schemesSubtitle: "നിങ്ങളുടെ ആവശ്യങ്ങൾക്ക് അനുയോജ്യമായ പദ്ധതികൾ കണ്ടെത്തുക. ഫിൽട്ടർ ചെയ്യാൻ ഒരു വിഭാഗത്തിൽ ക്ലിക്ക് ചെയ്യുക.", schemeFilterAll: "എല്ലാ പദ്ധതികളും", schemeFilterInsurance: "വിള ഇൻഷുറൻസ്", schemeFilterSubsidy: "സബ്സിഡി", schemeFilterIncome: "വരുമാന സഹായം", pmfbyTitle: "പ്രധാനമന്ത്രി ഫസൽ ബീമാ യോജന", pmfbyDesc: "വിളനാശം സംഭവിച്ചാൽ കർഷകർക്ക് സാമ്പത്തിക സഹായം നൽകുന്ന ഇൻഷുറൻസ് പദ്ധതി.", schemeEligibility: "യോഗ്യത:", pmfbyEligibility: "വിജ്ഞാപനം ചെയ്ത വിളകൾ കൃഷി ചെയ്യുന്ന എല്ലാ കർഷകരും.", schemeApply: "കൂടുതലറിയാം & അപേക്ഷിക്കാം", pmkisanTitle: "പിഎം-കിസാൻ പദ്ധതി", pmkisanDesc: "അർഹരായ എല്ലാ കർഷക കുടുംബങ്ങൾക്കും പ്രതിവർഷം ₹6,000 আর্থিক സഹായം നൽകുന്ന പദ്ധതി.", pmkisanEligibility: "എല്ലാ ഭൂരഹിത കർഷക കുടുംബങ്ങളും.", smamTitle: "കാർഷിക യന്ത്രവൽക്കരണ ഉപമിഷൻ", smamDesc: "ട്രാക്ടറുകൾക്കും മറ്റ് കാർഷിക യന്ത്രങ്ങൾക്കും സബ്സിഡി നൽകി യന്ത്രവൽക്കരണം പ്രോത്സാഹിപ്പിക്കുന്നു.", smamEligibility: "വ്യക്തിഗത കർഷകരും കർഷക ഗ്രൂപ്പുകളും.", nhmTitle: "ദേശീയ ഹോർട്ടികൾച്ചർ മിഷൻ", nhmDesc: "പഴങ്ങൾ, പച്ചക്കറികൾ തുടങ്ങിയ ഹോർട്ടികൾച്ചർ വിളകൾ കൃഷി ചെയ്യുന്നതിന് സബ്സിഡിയും പിന്തുണയും നൽകുന്നു.", nhmEligibility: "ഹോർട്ടികൾച്ചറിൽ ഏർപ്പെട്ടിരിക്കുന്ന കർഷകർ.", profileTitle: "നിങ്ങളുടെ കർഷക, ഫാം പ്രൊഫൈൽ ഉണ്ടാക്കുക", profileSubtitle: "വ്യക്തിഗത ഉപദേശങ്ങൾ ലഭിക്കുന്നതിനായി നിങ്ങളുടെ വിവരങ്ങൾ നൽകുക.", formName: "മുഴുവൻ പേര്", formDistrict: "ജില്ല (ഓട്ടോ-ഡിറ്റക്റ്റിനായി ക്ലിക്ക് ചെയ്യുക)", selectDistrict: "ജില്ല തിരഞ്ഞെടുക്കുക", formVillage: "ഗ്രാമം / പട്ടണം", selectVillage: "ഗ്രാമം തിരഞ്ഞെടുക്കുക", selectVillageFirst: "ആദ്യം ഒരു ജില്ല തിരഞ്ഞെടുക്കുക", formLandSize: "ഭൂമിയുടെ വലുപ്പം (ഏക്കറിൽ)", formCrop: "പ്രധാന വിള", selectCrop: "വിള തിരഞ്ഞെടുക്കുക", cropPaddy: "നെല്ല്", cropCoconut: "തെങ്ങ്", cropRubber: "റബ്ബർ", cropBanana: "വാഴ", formSoil: "മണ്ണിന്റെ തരം", selectSoil: "മണ്ണ് തിരഞ്ഞെടുക്കുക", soilAlluvial: "എക്കൽ", soilLaterite: "ചെങ്കൽ", soilClayey: "കളിമണ്ണ്", formButton: "പ്രൊഫൈൽ സേവ് ചെയ്യുക", chatTitle: "നിങ്ങളുടെ ഡിജിറ്റൽ സഹായി", chatSubtitle: "ചോദ്യങ്ങൾ ചോദിക്കുക അല്ലെങ്കിൽ നിങ്ങളുടെ പ്രവർത്തനങ്ങൾ മലയാളത്തിൽ രേഖപ്പെടുത്തുക.", chatPlaceholder: "ഒരു സന്ദേശം ടൈപ്പ് ചെയ്യുക...", chatGreeting: "നമസ്കാരം! ഞാൻ കൃഷി സഖി. നിങ്ങൾക്ക് എന്ത് സഹായമാണ് വേണ്ടത്?", footerDesc: "കൃഷി സഖി കർഷകരെ സഹായിക്കുന്നതിനുള്ള ഒരു എഐ സംരംഭമാണ്.", footerLinks: "പ്രധാന ലിങ്കുകൾ", footerAbout: "ഞങ്ങളെക്കുറിച്ച്", footerContact: "സഹായത്തിനായി ബന്ധപ്പെടുക", footerTerms: "സേവന നിബന്ധനകൾ" }
    };

    // --- DOM ELEMENTS ---
    const langSelector = document.getElementById('lang-selector'), fontButtons = document.querySelectorAll('.font-size-btn'), root = document.documentElement, districtSelect = document.getElementById('district-select'), villageSelect = document.getElementById('village-select'), locationStatus = document.getElementById('location-status'), mainCropSelect = document.getElementById('main-crop'), soilTypeSelect = document.getElementById('soil-type'), filterButtons = document.querySelectorAll('.filter-btn'), schemeCards = document.querySelectorAll('.scheme-card'), sendBtn = document.getElementById('send-btn'), userInput = document.getElementById('user-input'), chatBox = document.getElementById('chat-box');
    let currentLang = 'en';

    // --- FUNCTIONS ---
    const setLanguage = (lang) => { currentLang = lang; document.querySelectorAll('[data-key]').forEach(el => el.textContent = translations[lang]?.[el.getAttribute('data-key')] ?? el.textContent); userInput.placeholder = translations[lang].chatPlaceholder; chatBox.innerHTML = ''; addMessage(translations[lang].chatGreeting, 'assistant'); };
    const setFontSize = (size) => { fontButtons.forEach(btn => btn.classList.remove('active')); document.querySelector(`.font-size-btn[data-size="${size}"]`).classList.add('active'); if (size === 'small') root.style.fontSize = '14px'; else if (size === 'medium') root.style.fontSize = '16px'; else root.style.fontSize = '18px'; };
    const populateVillages = (district) => { villageSelect.innerHTML = `<option value="">${translations[currentLang].selectVillage}</option>`; if (district && locationData[district]) { locationData[district].villages.forEach(village => { const option = document.createElement('option'); option.value = village.toLowerCase().replace(' ', '-'); option.textContent = village; villageSelect.appendChild(option); }); villageSelect.disabled = false; } else { villageSelect.innerHTML = `<option value="">${translations[currentLang].selectVillageFirst}</option>`; villageSelect.disabled = true; } };
    const filterSchemes = (filter) => { filterButtons.forEach(btn => btn.classList.remove('active')); document.querySelector(`.filter-btn[data-filter="${filter}"]`).classList.add('active'); schemeCards.forEach(card => card.style.display = (filter === 'all' || filter === card.getAttribute('data-category')) ? 'block' : 'none'); };
    const addMessage = (text, sender) => { const messageContainer = document.createElement('div'); messageContainer.className = `message ${sender}-message`; const messageBubble = document.createElement('div'); messageBubble.innerHTML = `<p>${text}</p><span class="timestamp">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>`; messageContainer.appendChild(messageBubble); chatBox.appendChild(messageContainer); chatBox.scrollTop = chatBox.scrollHeight; };
    
    // --- IMPROVED CHATBOT LOGIC ---
    const getBotResponse = (userText) => {
        const lowerText = userText.toLowerCase();
        const crop = mainCropSelect.value ? mainCropSelect.options[mainCropSelect.selectedIndex].text : (currentLang === 'ml' ? 'നിങ്ങളുടെ വിള' : 'your crop');

        if (currentLang === 'ml') {
            if (lowerText.includes("നമസ്കാരം") || lowerText.includes("ഹലോ")) return "നമസ്കാരം! നിങ്ങളുടെ കൃഷി സംബന്ധമായ സംശയങ്ങൾക്ക് ഞാൻ എങ്ങനെ സഹായിക്കണം?";
            if (lowerText.includes("കാലാവസ്ഥ")) return "നിങ്ങൾ തിരഞ്ഞെടുത്ത ജില്ലയിലെ കാലാവസ്ഥാ പ്രവചനം അലേർട്ട് ബാനറിൽ കാണിക്കും. നിലവിൽ, ചിറ്റൂരിൽ കനത്ത മഴ പ്രതീക്ഷിക്കുന്നു.";
            if (lowerText.includes("പദ്ധതി")) return "'പദ്ധതികൾ' എന്ന വിഭാഗത്തിൽ നിങ്ങൾക്ക് എല്ലാ സർക്കാർ പദ്ധതികളും കണ്ടെത്താനാകും. ഏത് പദ്ധതിയെക്കുറിച്ചാണ് നിങ്ങൾക്ക് അറിയേണ്ടത്? ഉദാഹരണത്തിന്, പിഎം-കിസാൻ വരുമാന പിന്തുണ നൽകുന്നു.";
            if (lowerText.includes("വിത്ത്")) return `${crop}-ന് വിതയ്ക്കാനുള്ള സമയമായി. കൂടുതൽ വിവരങ്ങൾ ആവശ്യമുണ്ടോ?`;
            if (lowerText.includes("വളം")) return `${crop}-ന് NPK വളം ശുപാർശ ചെയ്യുന്നു. മണ്ണ് പരിശോധനയുടെ അടിസ്ഥാനത്തിൽ അളവ് ക്രമീകരിക്കുക.`;
            if (lowerText.includes("നന്ദി")) return "സ്വാഗതം! മറ്റെന്തെങ്കിലും അറിയണമെന്നുണ്ടോ?";
            return "ക്ഷമിക്കണം, എനിക്ക് മനസ്സിലായില്ല. നിങ്ങൾക്ക് കാലാവസ്ഥ, വിതയ്ക്കാനുള്ള സമയം, അല്ലെങ്കിൽ സർക്കാർ പദ്ധതികളെക്കുറിച്ച് ചോദിക്കാം.";
        } else {
            if (lowerText.includes("hello") || lowerText.includes("hi")) return "Hello! How can I assist you with your farming questions today?";
            if (lowerText.includes("weather")) return "The weather forecast for your selected district is displayed in the alert banner. Currently, it shows heavy rain is expected in Chittur.";
            if (lowerText.includes("scheme") || lowerText.includes("yojana")) return "You can find all government schemes in the 'Schemes' section. Are you interested in crop insurance, subsidies, or income support?";
            if (lowerText.includes("sow") || lowerText.includes("seed")) return `It is a good time for sowing ${crop}. Would you like more details?`;
            if (lowerText.includes("fertilizer") || lowerText.includes("manure")) return `A balanced NPK fertilizer is recommended for ${crop}. The exact amount should be based on a soil test.`;
            if (lowerText.includes("thank")) return "You're welcome! Is there anything else I can help you with?";
            return "I am sorry, I am still learning. Could you please rephrase? You can ask me about weather, sowing time, or government schemes.";
        }
    };

    const handleSendMessage = () => { const text = userInput.value.trim(); if (text) { addMessage(text, 'user'); userInput.value = ''; setTimeout(() => addMessage(getBotResponse(text), 'assistant'), 1000); } };

    // --- EVENT LISTENERS & INITIALIZATION ---
    langSelector.addEventListener('change', (e) => setLanguage(e.target.value));
    fontButtons.forEach(btn => btn.addEventListener('click', () => setFontSize(btn.getAttribute('data-size'))));
    filterButtons.forEach(btn => btn.addEventListener('click', () => filterSchemes(btn.getAttribute('data-filter'))));
    sendBtn.addEventListener('click', handleSendMessage);
    userInput.addEventListener('keypress', (e) => (e.key === 'Enter') && handleSendMessage());
    document.getElementById('voice-btn').addEventListener('click', () => alert(currentLang === 'ml' ? "വോയിസ് ഇൻപുട്ട് ഉടൻ വരുന്നു." : "Voice input is under development."));
    
    districtSelect.addEventListener('click', () => { if ("geolocation" in navigator) { locationStatus.textContent = "Requesting location..."; navigator.geolocation.getCurrentPosition( () => { locationStatus.textContent = "Auto-filling details..."; setTimeout(() => { const detectedDistrict = "Palakkad"; if (locationData[detectedDistrict]) { districtSelect.value = detectedDistrict; districtSelect.dispatchEvent(new Event('change')); mainCropSelect.value = locationData[detectedDistrict].crop; soilTypeSelect.value = locationData[detectedDistrict].soil; locationStatus.textContent = "Details auto-filled. You can change them."; } }, 500); }, () => locationStatus.textContent = "Location access denied. Please select manually." ); } }, { once: true });
    districtSelect.addEventListener('change', () => populateVillages(districtSelect.value));

    // --- INITIAL PAGE LOAD ---
    Object.keys(locationData).forEach(district => { const option = document.createElement('option'); option.value = district; option.textContent = district; districtSelect.appendChild(option); });
    setLanguage(langSelector.value); setFontSize('medium'); filterSchemes('all');
});